Use IAM Impersonation to Deploy a Virtual Machine Instance


Challenge scenario
To complete this challenge, you must deploy a new Compute Engine virtual machine using IAM service account impersonation.
Your student account does not have sufficient direct permissions to perform the individual tasks that must be completed. Your student account has been granted the Service Account Token Creator role on theÂ web-admin-saÂ IAM service account.
TheÂ web-admin-saÂ IAM service account has been bound to the following roles so that it can be used to create all of the resources required to complete this challenge.
* roles/storage.admin
* roles/compute.admin
* roles/storage.networkAdmin
It has also been bound to theÂ roles/serviceAccountUserÂ role on the Default Compute Engine Service Account so that it can be used to deploy instances with that service account.
Challenge tasks
You will need to perform the following tasks to complete this challenge:
1. Create a new storage bucket calledÂ gs://[SCRIPT-BUCKET]Â .
2. Copy the startup scriptÂ deploy-web-server.shÂ from the storage bucketÂ gs://[SOURCE-BUCKET]Â to the storage bucketÂ gs://[SCRIPT-BUCKET]Â .
3. Add a new firewall rule to the default VCP network that allows Instances containing the tagÂ http-serverto respond to web traffic from all addresses.
4. Deploy a new virtual machine calledÂ WEB_SERVERÂ that is configured to useÂ deploy-web-server.shÂ as its startup script.

Solution:

IAM_SA_NAME=$(gcloud iam service-accounts list | grep web-admin | awk -F ':' '{print $2}')

gcloud config set auth/impersonate_service_account $IAM_SA_NAME

BUCKET_NAME=$(gcloud alpha storage ls | grep web)

gcloud alpha storage buckets create gs://$GOOGLE_CLOUD_PROJECT-startup

gcloud alpha storage cp $BUCKET_NAME\* gs://$GOOGLE_CLOUD_PROJECT-startup/

gcloud compute firewall-rules create allow-http --target-tags http-server --source-ranges 0.0.0.0/0 --allow tcp:80

gcloud compute instances create test-server --zone=us-central1-a --tags=http-server --metadata startup-script-url=gs://$GOOGLE_CLOUD_PROJECT-startup/deploy-web-server.sh


#GoogleClout
Google Clout - Use IAM Impersonation to Deploy a Virtual Machine Instance Challenge.
0ï¸âƒ£5ï¸âƒ£	ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦
1ï¸âƒ£0ï¸âƒ£	â¬œâ¬œâ¬œâ¬œ
1ï¸âƒ£5ï¸âƒ£	â¬œâ¬œâ¬œâ¬œ
2ï¸âƒ£0ï¸âƒ£	â¬œâ¬œâ¬œâ¬œ
Challenge completed in 1 minutes and 11 seconds !
